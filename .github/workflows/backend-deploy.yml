name: Backend Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Backend to AWS Lambda
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS credentials
        run: |
          echo "âœ… Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS credentials verified!"

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Build TypeScript backend
        run: |
          cd backend
          echo "ðŸ”¨ Building TypeScript..."
          npm run build
          echo "âœ… TypeScript build complete!"

      - name: Fix SAM template structure
        run: |
          cd backend
          
          # Create fix-structure.py
          cat > fix-structure.py << 'PYEOF'
          import os
          
          # Only run if template-production.yaml exists
          if not os.path.exists('template-production.yaml'):
              print("âš ï¸ template-production.yaml not found, skipping structure fix")
              exit(0)
          
          with open('template-production.yaml', 'r') as f:
              lines = f.readlines()

          resources_start = None
          outputs_start = None
          userstable_start = None

          for i, line in enumerate(lines):
              if line.strip() == 'Resources:':
                  resources_start = i
              elif line.strip() == 'Outputs:':
                  outputs_start = i
              elif line.strip() == '# DynamoDB Table for Users':
                  userstable_start = i

          if userstable_start and userstable_start > outputs_start:
              userstable_section = lines[userstable_start:]
              before_userstable = lines[:userstable_start-1]
              new_lines = before_userstable[:outputs_start] + ['\n'] + userstable_section + ['\n'] + before_userstable[outputs_start:]
              
              with open('template-production.yaml', 'w') as f:
                  f.writelines(new_lines)
              
              print("âœ… Moved UsersTable to Resources section")
          else:
              print("âœ… UsersTable already in correct location")
          PYEOF
          
          python3 fix-structure.py
          
          # Create fix-policy.py
          cat > fix-policy.py << 'PYEOF'
          import os
          
          if not os.path.exists('template-production.yaml'):
              print("âš ï¸ template-production.yaml not found, skipping policy fix")
              exit(0)
          
          with open('template-production.yaml', 'r') as f:
              content = f.read()

          old_policy = '''      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable'''

          new_policy = '''      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource: !GetAtt UsersTable.Arn'''

          if old_policy in content:
              content = content.replace(old_policy, new_policy)
              with open('template-production.yaml', 'w') as f:
                  f.write(content)
              print("âœ… Fixed DynamoDBCrudPolicy")
          else:
              print("âœ… DynamoDBCrudPolicy already fixed or not present")
          PYEOF
          
          python3 fix-policy.py
          
          # Remove Metadata sections requiring Makefiles
          if [ -f "template-production.yaml" ]; then
            sed -i '/Metadata:/,/BuildMethod: makefile/d' template-production.yaml 2>/dev/null || true
          fi
          
          echo "âœ… Template fixes applied"

      - name: Build SAM application
        run: |
          cd backend
          echo "ðŸ“¦ Building SAM application..."
          if [ -f "template-production.yaml" ]; then
            sam build --template-file template-production.yaml
          else
            sam build
          fi
          echo "âœ… SAM build complete!"

      - name: Deploy to AWS Lambda
        id: deploy
        run: |
          cd backend
          echo "ðŸš€ Deploying to AWS Lambda..."
          sam deploy \
            --template-file .aws-sam/build/template.yaml \
            --stack-name taxflowai-backend \
            --capabilities CAPABILITY_IAM \
            --region us-east-1 \
            --resolve-s3 \
            --s3-prefix taxflowai-backend \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset
          echo "âœ… Deployment complete!"

      - name: Get API endpoint
        id: endpoint
        run: |
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name taxflowai-backend \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text \
            --region us-east-1)
          echo "API_ENDPOINT=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "ðŸŒ API Endpoint: $API_ENDPOINT"

      - name: Test API endpoints
        id: test
        run: |
          cd backend
          if [ -f "scripts/test-deployment.sh" ]; then
            chmod +x scripts/test-deployment.sh
            ./scripts/test-deployment.sh ${{ steps.endpoint.outputs.API_ENDPOINT }}
          else
            echo "âš ï¸ Test script not found, skipping tests"
          fi
        continue-on-error: true

      - name: Post deployment status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const apiEndpoint = '${{ steps.endpoint.outputs.API_ENDPOINT }}';
            const testStatus = '${{ steps.test.outcome }}';
            const testIcon = testStatus === 'success' ? 'âœ…' : 'âš ï¸';
            
            const comment = `## ðŸš€ Backend Deployment Status
            
            **Deployment:** âœ… Successful
            **API Endpoint:** \`${apiEndpoint}\`
            **Tests:** ${testIcon} ${testStatus === 'success' ? 'Passed' : 'Failed (check logs)'}
            
            ### Deployed Functions
            - âœ… AuthFunction
            - âœ… DocumentFunction
            - âœ… UserFunction
            - âœ… NotificationFunction
            
            ### Next Steps
            1. Update frontend \`NEXT_PUBLIC_API_URL\` with the API endpoint
            2. Test authentication endpoints
            3. Verify CORS configuration
            
            ---
            _Deployment completed at ${new Date().toISOString()}_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **API Endpoint:** ${{ steps.endpoint.outputs.API_ENDPOINT }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª **Tests:** ${{ steps.test.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- AWS Lambda Functions (4)" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway REST API" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB UsersTable" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch Log Groups" >> $GITHUB_STEP_SUMMARY
          echo "- IAM Roles and Policies" >> $GITHUB_STEP_SUMMARY
